version: 2.1

orbs:
  node: circleci/node@5.1.0
  aws-cli: circleci/aws-cli@3.1
  serverless-framework: circleci/serverless-framework@2.0

jobs:
  build_deploy:
    executor:
      name: node/default
      tag: '14.15.0'
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn
      - run:
          name: Build
          command: yarn clean && yarn build
      - run:
          name: Update package
          command: yarn update undici
      # - run:
      #     name: Install lambda:sls
      #     command: |
      #       yarn add global @redantinc/lambda-sls
      - checkout
      - aws-cli/setup
      - serverless-framework/setup
      - run:
          name: Deploy to AWS Lambda
          command: |
            yarn lambda:deploy
      # - run:
      #     name: Install lambda:sls
      #     command: |
      #       yarn add global @redantinc/lambda-sls
      # - run:
      #     name: Deploy
      #     command: yarn run lambda:sls deploy

  # deploy_app:
  #   docker:
  #     - image: circleci/python:3.8
  #   steps:

workflows:
  build_and_deploy:
    jobs:
      - build_deploy:
          filters:
            branches:
              only: master
      # - deploy_app:
      #     requires:
      #       - build_deploy
      #     filters:
      #       branches:
      #         only: master
